import{C as h,i as k,a as p,b as g,c as y}from"./index-5ktqP_Id.js";import{M as f}from"./bootstrap.esm-i6_6fk2u.js";import"./index-BEKk9TLb.js";class E{constructor(){this.calendar=document.getElementById("task-calendar"),this.calendarObj=null,this.taskDetailsModal=new f(document.getElementById("task-details-modal")),this.taskFormModal=new f(document.getElementById("task-form-modal")),this.currentFilters={},this.currentTaskId=null,this.isEditMode=!1,this.init()}init(){this.setupCalendar(),this.setupFilters(),this.setupEventListeners(),this.setupTaskFormModal()}setupCalendar(){const t=this;this.calendarObj=new h(this.calendar,{plugins:[k,p,g,y],initialView:"dayGridMonth",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay,listMonth"},height:"auto",editable:!0,droppable:!0,selectable:!0,selectMirror:!0,eventDisplay:"block",dayMaxEvents:!0,events:function(e,s,o){t.fetchTasks(e,s,o)},eventClick:function(e){t.showTaskDetails(e.event)},eventDrop:function(e){if(typeof isStaff<"u"&&isStaff===!0){e.revert();return}t.updateTaskDate(e.event,e.event.start)},eventResize:function(e){t.updateTaskDate(e.event,e.event.start)},dateClick:function(e){t.openTaskFormModal(e.dateStr)},loading:function(e){e?document.body.style.cursor="wait":document.body.style.cursor="default"}}),this.calendarObj.render()}setupTaskFormModal(){const t=this;if(document.getElementById("task-form").addEventListener("submit",function(s){s.preventDefault(),t.submitTaskForm()}),document.getElementById("task-form-modal").addEventListener("hidden.bs.modal",function(){t.resetTaskForm(),t.forceModalCleanup()}),isStaff){const s=document.getElementById("modal-quick-edit-btn");s&&(s.style.display="none");const o=document.getElementById("modal-edit-link");o&&(o.style.display="none")}const e=document.getElementById("modal-quick-edit-btn");e&&!isStaff&&e.addEventListener("click",function(){t.openTaskFormModalForEdit()}),document.getElementById("task-form-modal").addEventListener("click",function(s){s.target===this&&(t.taskFormModal.hide(),t.forceModalCleanup())}),window.forceCloseTaskModal=function(){t.taskFormModal.hide(),t.forceModalCleanup()}}openTaskFormModal(t=null){if(this.forceModalCleanup(),this.isEditMode=!1,this.currentTaskId=null,document.getElementById("taskFormModalLabel").textContent="Add New Task",document.getElementById("modal-submit-text").textContent="Create Task",this.resetTaskForm(),t)document.getElementById("modal-task_date").value=t,this.loadStaffWorkload(t);else{const e=new Date().toISOString().split("T")[0];document.getElementById("modal-task_date").value=e,this.loadStaffWorkload(e)}this.taskFormModal.show()}openTaskFormModalForEdit(){if(!this.currentTaskId)return;const t=this.calendarObj.getEventById(this.currentTaskId);if(!t)return;this.forceModalCleanup(),this.isEditMode=!0,document.getElementById("taskFormModalLabel").textContent="Edit Task",document.getElementById("modal-submit-text").textContent="Update Task";const e=t.extendedProps,s=t.start.toISOString().split("T")[0];document.getElementById("modal-customer_id").value=e.customer_id||"",document.getElementById("modal-task_date").value=s,document.getElementById("modal-task_type_id").value=e.task_type_id||"",document.getElementById("modal-assigned_to").value=e.assigned_to||"",document.getElementById("modal-status").value=e.status||"pending",document.getElementById("modal-note_content").value=e.note_content||"",this.loadStaffWorkload(s),this.taskDetailsModal.hide(),this.taskFormModal.show()}submitTaskForm(){const t=document.getElementById("task-form"),e=new FormData(t);console.log("Form element:",t),console.log("Form validity:",t.checkValidity()),this.isEditMode&&e.append("_method","PUT");const s={};e.forEach((n,l)=>{s[l]=n}),console.log("Form data:",s),console.log("Is edit mode:",this.isEditMode),console.log("Current task ID:",this.currentTaskId);const a=["customer_id","task_type_id","task_date","status"].filter(n=>!s[n]);a.length>0&&console.warn("Missing required fields:",a);const r=this.isEditMode?`/api/tasks/${this.currentTaskId}`:"/api/tasks",d=this.isEditMode?"PUT":"POST";console.log("Request URL:",r),console.log("Request method:",d),this.clearFormErrors();const i=t.querySelector('button[type="submit"]'),c=i.innerHTML;i.innerHTML='<i class="bx bx-loader bx-spin me-1"></i> Saving...',i.disabled=!0;const u=document.querySelector('meta[name="csrf-token"]');if(!u){console.error("CSRF token meta tag not found"),this.showNotification("CSRF token not found. Please refresh the page.","error"),i.innerHTML=c,i.disabled=!1;return}const m=u.getAttribute("content");console.log("CSRF token:",m?"Found":"Missing"),fetch(r,{method:d,headers:{"Content-Type":"application/json","X-CSRF-TOKEN":m},body:JSON.stringify(s)}).then(n=>(console.log("Response status:",n.status),console.log("Response headers:",n.headers),n.json())).then(n=>{console.log("Response data:",n),n.success?(this.showNotification(n.message||"Task saved successfully!","success"),this.taskFormModal.hide(),setTimeout(()=>{document.querySelectorAll(".modal-backdrop").forEach(l=>{l.remove()}),document.body.classList.remove("modal-open"),document.body.style.paddingRight="",document.body.style.overflow=""},100),this.resetTaskForm(),this.calendarObj.refetchEvents()):n.errors?(console.log("Validation errors:",n.errors),this.showFormErrors(n.errors)):this.showNotification(n.message||"Error saving task.","error")}).catch(n=>{console.error("Fetch error:",n),this.showNotification("Error saving task.","error"),setTimeout(()=>{document.querySelectorAll(".modal-backdrop").forEach(l=>{l.remove()}),document.body.classList.remove("modal-open"),document.body.style.paddingRight="",document.body.style.overflow=""},100)}).finally(()=>{i.innerHTML=c,i.disabled=!1})}resetTaskForm(){document.getElementById("task-form").reset(),this.clearFormErrors(),document.getElementById("modal-status").value="pending",this.resetStaffOptions()}clearFormErrors(){document.querySelectorAll("#task-form .invalid-feedback").forEach(s=>s.textContent=""),document.querySelectorAll("#task-form .form-control, #task-form .form-select").forEach(s=>s.classList.remove("is-invalid"))}showFormErrors(t){Object.keys(t).forEach(e=>{const s=document.getElementById(`modal-${e}`),o=s?s.nextElementSibling:null;s&&o&&o.classList.contains("invalid-feedback")&&(s.classList.add("is-invalid"),o.textContent=t[e][0])})}fetchTasks(t,e,s){const o=new URLSearchParams({start:t.startStr,end:t.endStr,...this.currentFilters});fetch(`/api/tasks-calendar?${o}`,{method:"GET",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}}).then(a=>a.json()).then(a=>{e(a)}).catch(a=>{console.error("Error fetching tasks:",a),s(a)})}updateTaskDate(t,e){const s=t.extendedProps.task_id,o=e.toISOString().split("T")[0];fetch(`/api/tasks/${s}/update-date`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({task_date:o})}).then(a=>a.json()).then(a=>{a.success?this.showNotification("Task date updated successfully!","success"):(this.showNotification("Error updating task date.","error"),t.revert())}).catch(a=>{console.error("Error updating task date:",a),this.showNotification("Error updating task date.","error"),t.revert()})}showTaskDetails(t){const e=t.extendedProps;this.currentTaskId=e.task_id,document.getElementById("modal-customer").textContent=e.customer_name,document.getElementById("modal-task-type").textContent=e.task_type,document.getElementById("modal-assigned-to").textContent=e.assigned_to_name,document.getElementById("modal-status").innerHTML=`<span class="badge bg-${this.getStatusColor(e.status)}">${e.status_label}</span>`,document.getElementById("modal-notes").textContent=e.note_content||"No notes available",isStaff||(document.getElementById("modal-edit-link").href=`/tasks/${e.task_id}/edit?redirect_to=calendar`);const s=document.getElementById("modal-status-select");s&&(s.value=e.status),this.taskDetailsModal.show()}getStatusColor(t){return{pending:"warning",in_progress:"info",completed:"success",cancelled:"danger"}[t]||"primary"}setupFilters(){const t=this;document.getElementById("apply-filters").addEventListener("click",function(){t.applyFilters()}),document.getElementById("clear-filters").addEventListener("click",function(){t.clearFilters()}),["filter-customer","filter-task-type","filter-assigned-to","filter-status"].forEach(s=>{document.getElementById(s).addEventListener("change",function(){t.applyFilters()})})}applyFilters(){this.currentFilters={};const t={"filter-customer":"customer_id","filter-task-type":"task_type_id","filter-assigned-to":"assigned_to","filter-status":"status","filter-content-status":"content_status","filter-publish-status":"publish_status"};Object.keys(t).forEach(e=>{const s=document.getElementById(e);s&&s.value&&(this.currentFilters[t[e]]=s.value)}),this.calendarObj.refetchEvents()}clearFilters(){this.currentFilters={},document.getElementById("calendar-filters").reset(),this.calendarObj.refetchEvents()}setupEventListeners(){window.addEventListener("resize",()=>{this.calendarObj.updateSize()}),document.addEventListener("keydown",o=>{o.key==="Escape"&&(this.taskDetailsModal._isShown&&this.taskDetailsModal.hide(),this.taskFormModal._isShown&&(this.taskFormModal.hide(),this.forceModalCleanup()))});const t=document.querySelector('[data-bs-target="#task-form-modal"]');isStaff&&(t.style.display="none"),t&&!isStaff&&t.addEventListener("click",()=>{this.openTaskFormModal()});const e=document.getElementById("modal-status-form");e&&e.addEventListener("submit",o=>{o.preventDefault(),this.updateTaskStatus()});const s=document.getElementById("modal-task_date");s&&s.addEventListener("change",()=>{s.value&&this.loadStaffWorkload(s.value)})}updateTaskStatus(){const t=document.getElementById("modal-status-select"),e=document.getElementById("modal-update-status-btn");if(!t||!this.currentTaskId)return;const s=t.value;e.disabled=!0,e.innerHTML='<i class="bx bx-loader bx-spin me-1"></i> Updating...',fetch(`/tasks/${this.currentTaskId}/update-status`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json"},body:JSON.stringify({status:s})}).then(o=>{if(!o.ok)throw new Error("Network response was not ok");return o.json()}).then(o=>{if(o.success){const a=document.getElementById("modal-status"),r=this.getStatusLabel(s);a.innerHTML=`<span class="badge bg-${this.getStatusColor(s)}">${r}</span>`,this.calendarObj.refetchEvents(),this.showNotification(o.message,"success")}else throw new Error(o.message||"Failed to update status")}).catch(o=>{console.error("Error updating status:",o),this.showNotification("Failed to update task status. Please try again.","error")}).finally(()=>{e.disabled=!1,e.innerHTML='<i class="bx bx-check me-1"></i> Update Status'})}getStatusLabel(t){return{pending:"Pending",in_progress:"In Progress",completed:"Completed",cancelled:"Cancelled"}[t]||t}showNotification(t,e="info"){const s=document.createElement("div");s.className=`alert alert-${e==="error"?"danger":e} alert-dismissible fade show position-fixed`,s.style.cssText="top: 20px; right: 20px; z-index: 9999; min-width: 300px;",s.innerHTML=`
            ${t}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `,document.body.appendChild(s),setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},5e3)}refresh(){this.calendarObj.refetchEvents()}loadStaffWorkload(t){document.getElementById("modal-assigned_to")&&fetch(`/api/staff-workload?date=${t}`).then(s=>s.json()).then(s=>{s.success&&this.updateStaffOptions(s.staff_workload)}).catch(s=>console.error("Error loading staff workload:",s))}updateStaffOptions(t){const e=document.getElementById("modal-assigned_to");if(!e)return;e.querySelectorAll("option").forEach(o=>{if(o.value==="")return;o.getAttribute("data-original-text")||o.setAttribute("data-original-text",o.innerHTML);const a=parseInt(o.value),r=t.find(d=>d.id===a);if(r){const d=this.getCapacityBadge(r.capacity_percentage),i=r.can_assign_more?"Available":"At Capacity";o.innerHTML=`${r.name} (${r.current_tasks}/${r.max_tasks} tasks) ${d}`,o.disabled=!r.can_assign_more,o.title=`${i} - ${r.current_tasks} current tasks, max ${r.max_tasks}`}})}getCapacityBadge(t){return t>=100?"🔴":t>=80?"🟠":t>=60?"🟡":"🟢"}resetStaffOptions(){const t=document.getElementById("modal-assigned_to");if(!t)return;t.querySelectorAll("option").forEach(s=>{if(s.value==="")return;const o=s.getAttribute("data-original-text");o&&(s.innerHTML=o),s.disabled=!1,s.title=""})}forceModalCleanup(){document.querySelectorAll(".modal-backdrop").forEach(e=>{e.remove()}),document.body.classList.remove("modal-open"),document.body.style.paddingRight="",document.body.style.overflow="";const t=document.getElementById("task-form-modal");t&&(t.classList.remove("show"),t.style.display="none",t.setAttribute("aria-hidden","true"),t.removeAttribute("aria-modal"))}}document.addEventListener("DOMContentLoaded",function(){window.taskCalendar=new E});
